/* global Electron */
import React from 'react';
import classNames from 'classnames';
import { withTranslation } from 'react-i18next';
import PropTypes from 'prop-types';
import { connect } from 'react-redux';

import { formatValue, formatUnit } from 'libs/iota/utils';

import { isSettingUpNewAccount } from 'selectors/accounts';

import Icon from 'ui/components/Icon';
import Button from 'ui/components/Button';

import css from './index.scss';

/**
 * Ledger UI helpers
 */
class Ledger extends React.PureComponent {
    static timeout = null;

    static propTypes = {
        /** @ignore */
        t: PropTypes.func.isRequired,
        /** @ignore */
        addingAdditionalAccount: PropTypes.bool.isRequired,
        /** @ignore */
        sendAddressFieldText: PropTypes.string,
    };

    state = {
        view: null,
        transaction: null,
    };

    componentDidMount() {
        this.messageEvent = this.onMessage.bind(this);
        Electron.onEvent('ledger', this.messageEvent);
    }

    componentWillUnmount() {
        Electron.removeEvent('ledger', this.messageEvent);
    }

    onMessage(message) {
        let view = null;
        let transaction = null;

        if (message.awaitConnection) {
            view = 'connection';
        } else if (message.awaitApplication) {
            view = 'application';
        } else if (message.awaitTransaction) {
            view = 'transaction';
            transaction = message.awaitTransaction;
        }

        this.setState({
            view,
            transaction,
        });
    }

    onCancel = (e) => {
        e.preventDefault();
        Electron.send('ledger', { abort: true });

        this.setState({
            view: null,
        });
    };

    getIcon(type) {
        switch (type) {
            case 'connection':
                return (
                    <svg width="48" height="46" viewBox="0 0 48 46" xmlns="http://www.w3.org/2000/svg">
                        <path
                            fill="#000"
                            d="M9.492 33.75c0 11.25 17.578 11.25 17.578 0 0-.582.473-1.055 1.055-1.055s1.055.472 1.055 1.055c0 14.063-21.797 14.063-21.797 0v-13.125h2.109v.468c0 .582-.473 1.055-1.055 1.055s-1.055-.473-1.055-1.055v-.468h2.109v13.125zm19.688-25.313c0 .582-.473 1.055-1.055 1.055s-1.055-.473-1.055-1.055c0-5.112 3.563-8.438 8.086-8.438s8.086 3.326 8.086 8.438v20.391h-2.109v-20.391c0-3.912-2.589-6.328-5.977-6.328-3.388 0-5.977 2.416-5.977 6.328zM39.375 44.297h5.625v-2.813h-5.625v2.813zm-1.406-4.219h8.438v5.625h-8.438v-5.625zM42.188 26.719c2.813 0 5.625 1.406 5.625 5.625v5.625h-11.25v-5.625c0-4.219 2.813-5.625 5.625-5.625zM16.875 23.906c-.03 4.68-3.758 8.408-8.438 8.438-4.684-.02-8.418-3.753-8.438-8.438v-5.625h16.875v5.625zM14.063 9.141h-11.25v5.625h11.25v-5.625zm1.406 7.031h-14.063v-8.438h14.063v8.438zM23.203 19.688h9.844v2.813h-9.844z"
                        />
                    </svg>
                );
            case 'application':
                return (
                    <svg width="174" height="66" viewBox="0 0 87 33" xmlns="http://www.w3.org/2000/svg">
                        <path d="M44 16h4v2h-4v4h-2v-4h-4v-2h4v-4h2z" />
                        <path d="M19.95 33h-6.915c-9.015 0-13.035-4.035-13.035-13.05v-6.915c0-9.015 4.02-13.035 13.035-13.035h6.915c9.015 0 13.05 4.02 13.05 13.035v6.915c0 9.015-4.035 13.05-13.05 13.05zm-6.915-32.4c-8.535 0-12.435 3.9-12.435 12.435v6.915c0 8.55 3.9 12.435 12.435 12.435h6.915c8.595 0 12.435-3.84 12.435-12.435v-6.915c0-8.535-3.885-12.435-12.435-12.435h-6.915zm7.965 6.36c-.638 0-1.155.517-1.155 1.155s.517 1.155 1.155 1.155 1.155-.517 1.155-1.155-.517-1.155-1.155-1.155zm-.66 4.215c0 .538.437.975.975.975.403.006.77-.233.927-.604.157-.371.073-.801-.212-1.086-.285-.285-.714-.369-1.086-.212-.371.157-.61.524-.604.927zm-.15 2.565c0 .219.087.429.242.583.155.155.365.242.583.242.219 0 .429-.087.583-.242.155-.155.242-.365.242-.583 0-.221-.089-.434-.247-.589-.158-.155-.372-.24-.593-.236-.217 0-.426.087-.578.243-.152.155-.236.365-.232.582zm0 1.365c-.293 0-.556.177-.667.448-.111.271-.046.582.163.786.209.205.521.263.79.146.269-.116.44-.383.434-.676.001-.372-.288-.681-.66-.705h-.06zm-1.02 1.68c-.299.047-.519.305-.519.607 0 .303.22.56.519.608.24.038.479-.069.612-.273.132-.204.132-.466 0-.67-.132-.204-.372-.31-.612-.273zm-1.14 1.185c-.298 0-.54.242-.54.54 0 .298.242.54.54.54.298 0 .54-.242.54-.54-.013-.265-.217-.481-.48-.51l-.06-.03zm6-7.395c-.525-.119-1.046.21-1.166.735-.119.525.209 1.047.733 1.167.524.12 1.047-.207 1.168-.731.136-.5-.149-1.018-.645-1.17h-.09zm-.345 2.73c-.447-.104-.894.17-1.005.615-.116.304-.046.649.181.883.226.234.568.317.876.211.308-.106.528-.38.563-.704.112-.42-.116-.856-.525-1.005h-.09zm-.78 2.19c-.183-.045-.377-.015-.537.084-.161.099-.275.258-.318.441-.085.38.148.759.525.855.381.091.764-.144.855-.525.091-.381-.144-.764-.525-.855zm-1.05 1.68c-.323-.079-.649.119-.727.442-.079.323.119.649.442.727.323.079.649-.119.727-.442.079-.323-.119-.649-.442-.727zm-1.17 1.17c-.137-.036-.283-.015-.405.059-.122.073-.208.193-.24.331-.055.213.024.438.2.569.176.131.414.143.602.029.188-.114.288-.33.254-.547-.034-.217-.197-.391-.411-.441zm-1.155.69c-.29-.065-.578.116-.645.405-.066.285.107.571.39.645.29.065.578-.116.645-.405.076-.26-.053-.536-.3-.645h-.09zm6.36-4.92c-.417-.201-.919-.027-1.121.391-.202.417-.028.919.389 1.122.417.203.919.029 1.122-.387.227-.394.093-.897-.3-1.125h-.09zm-.81 2.19c-.169-.082-.364-.094-.541-.032-.177.062-.323.192-.404.362-.167.351-.02.771.331.939.35.168.771.022.94-.328.169-.35.024-.771-.326-.941zm-.96 1.695c-.147-.072-.317-.083-.472-.029-.155.054-.282.167-.353.314-.142.307-.016.671.285.825.307.142.671.016.825-.285.072-.147.083-.317.029-.472-.054-.155-.167-.282-.314-.353zm-1.08 1.08c-.27-.12-.586-.008-.72.255-.061.127-.069.273-.021.406s.147.24.276.299c.124.066.271.078.405.033s.242-.144.3-.273c.072-.13.088-.285.042-.427-.045-.142-.148-.259-.282-.323v.03zm-1.11.735c-.27-.12-.586-.008-.72.255-.061.127-.069.273-.021.406s.147.24.276.299c.124.066.271.078.405.033s.242-.144.3-.273c.072-.13.088-.285.042-.427-.045-.142-.148-.259-.282-.323v.03zm-1.245.435c-.27-.12-.586-.008-.72.255-.137.286-.016.628.27.765.286.137.628.016.765-.27.08-.143.09-.314.029-.465-.061-.152-.188-.267-.344-.315v.03zm2.64 4.65c.319-.555.128-1.264-.427-1.582-.555-.319-1.264-.128-1.582.428-.206.359-.205.801.002 1.159.208.358.591.578 1.005.578.414-.001.796-.223 1.003-.582zm-3-1.32c.193-.297.213-.675.051-.991-.161-.316-.478-.522-.832-.54-.354-.018-.691.154-.884.451-.272.472-.111 1.076.36 1.35.452.281 1.047.148 1.335-.3l-.03.03zm-2.175-1.665c.113-.188.145-.414.088-.626-.057-.212-.197-.392-.388-.499-.399-.22-.901-.088-1.14.3-.226.402-.085.911.315 1.14.191.108.417.135.628.076.211-.059.39-.2.497-.391zm-1.5-1.755c.097-.16.125-.353.076-.534-.048-.181-.168-.335-.331-.426-.247-.144-.556-.126-.783.047-.227.173-.328.466-.254.742.073.276.306.481.589.518.283.037.561-.1.703-.347zm-.93-1.71c.081-.139.103-.305.06-.46-.042-.155-.145-.287-.285-.365-.137-.082-.301-.106-.456-.067-.155.039-.288.139-.369.277-.087.138-.114.306-.074.465.04.159.142.294.284.375.288.142.637.046.81-.225h.03zm-.465-1.575c.111-.189.096-.426-.036-.6s-.357-.251-.568-.195c-.212.056-.368.234-.397.451-.029.217.076.43.266.539.251.121.552.038.705-.195h.03zm1.695 8.235c-.006.402.231.767.601.925.369.158.798.077 1.084-.205.286-.282.374-.709.221-1.081-.152-.372-.514-.615-.916-.615-.265-.008-.522.091-.714.274-.192.183-.302.436-.306.701h.03zm-.45-1.005c.16-.153.25-.364.25-.585 0-.221-.09-.432-.25-.585-.155-.156-.365-.243-.585-.243-.22 0-.43.088-.585.243-.326.328-.326.857 0 1.185.33.312.848.305 1.17-.015zm-1.5-1.77c.134-.13.209-.308.209-.495s-.076-.365-.209-.495c-.133-.135-.314-.211-.502-.211-.189 0-.37.076-.503.211-.272.28-.272.725 0 1.005.135.133.317.206.506.203.189-.003.369-.081.499-.218zm-.93-1.74c.174-.171.228-.43.135-.655-.092-.226-.312-.373-.555-.373-.244 0-.463.147-.555.373-.092.226-.039.485.135.655.222.184.543.184.765 0h.075zm-.42-1.59c.131-.142.177-.343.12-.528-.057-.185-.209-.325-.398-.367-.189-.043-.386.018-.517.16-.203.22-.19.562.03.765.22.203.562.19.765-.03zm0-1.365c.202-.209.202-.541 0-.75-.097-.105-.233-.164-.375-.164s-.278.06-.375.164c-.101.099-.158.234-.158.375s.057.276.158.375c.18.126.42.126.6 0h.15zm1.08 7.98c.279-.155.446-.454.432-.773-.014-.319-.208-.602-.5-.73-.292-.129-.632-.081-.877.123-.379.265-.479.783-.225 1.17.256.321.706.41 1.065.21h.105zm-1.5-1.785c.319-.226.399-.666.18-.99-.104-.159-.268-.269-.454-.306-.186-.037-.38.003-.536.111-.292.236-.354.656-.142.966.212.31.626.405.952.219zm-.915-1.74c.275-.195.348-.572.165-.855-.191-.282-.573-.356-.855-.165-.282.191-.356.573-.165.855.186.226.503.294.765.165h.09zm-.45-1.5c.12-.079.203-.203.231-.344.028-.141-.001-.287-.081-.406-.104-.172-.295-.273-.496-.26-.201.012-.378.136-.46.32-.082.184-.054.398.071.556.148.202.418.271.645.165l.09-.03zm0-1.32c.172-.104.273-.295.26-.496-.012-.201-.136-.378-.32-.46-.184-.082-.398-.054-.556.071-.116.079-.196.201-.221.339-.025.138.006.281.086.396.147.202.414.277.645.18l.105-.03zm.135-1.275c.244-.17.304-.505.135-.75-.079-.116-.201-.196-.339-.221-.138-.025-.281.006-.396.086-.119.077-.201.198-.229.336-.028.138 0 .282.079.399.079.12.203.203.344.231.141.028.287-.001.406-.081zm-5.37 0c.355.479 1.013.615 1.529.315.515-.3.723-.939.481-1.485-.182-.411-.582-.681-1.031-.696-.449-.015-.866.228-1.075.626-.209.398-.171.879.096 1.24zm2.64-1.905c.129.225.342.39.593.458.251.068.518.032.742-.098.465-.269.625-.865.356-1.331-.269-.466-.864-.626-1.33-.359-.466.268-.628.863-.361 1.329zm2.505-1.095c.229.4.738.541 1.14.315.268-.15.435-.432.44-.739.004-.307-.156-.593-.42-.75-.264-.157-.592-.161-.86-.011-.206.109-.355.3-.413.526-.057.226-.016.465.113.659zm2.28-.435c.201.336.635.45.975.255.334-.196.448-.624.255-.96-.075-.179-.221-.319-.402-.387-.182-.068-.383-.058-.558.027-.172.094-.299.255-.35.445-.051.19-.022.392.08.56v.06zm1.965 0c.09.224.303.374.544.384.241.01.466-.121.575-.337.109-.215.082-.474-.069-.663-.191-.238-.527-.3-.79-.146s-.374.478-.26.761zm1.59.39c.15.256.478.343.735.195.122-.069.211-.184.248-.319.037-.135.018-.279-.053-.401-.165-.211-.458-.269-.691-.138-.233.131-.334.413-.239.663zm-9.42-1.5c.11.387.443.67.843.715.4.045.787-.158.98-.511.192-.354.151-.789-.104-1.1-.255-.311-.674-.437-1.058-.318-.496.152-.787.666-.66 1.17v.045zm2.55-1.05c.137.436.597.682 1.035.555.439-.133.688-.596.555-1.035-.133-.439-.596-.688-1.035-.555-.414.136-.655.566-.555.99v.045zm2.295-.405c.048.181.169.333.334.421.165.088.359.104.536.044.372-.109.586-.497.48-.87-.043-.191-.161-.356-.328-.458-.167-.102-.368-.131-.557-.082-.194.054-.356.188-.444.368-.089.181-.096.39-.021.577zm1.965 0c.101.314.432.493.75.405.319-.095.5-.431.405-.75-.095-.319-.431-.5-.75-.405-.314.101-.493.432-.405.75zm1.605.42c.038.136.13.251.254.319s.271.083.406.041c.136-.038.251-.13.319-.254s.083-.271.041-.406c-.038-.136-.13-.251-.254-.319s-.271-.083-.406-.041c-.14.038-.258.132-.326.26s-.08.278-.034.415v-.015zm1.185.66c.087.285.389.445.674.358.285-.087.446-.388.359-.673-.087-.285-.388-.446-.673-.36-.141.041-.259.138-.327.268s-.08.282-.033.422v-.015zm-7.5-3c.015.222.119.428.289.572.169.144.39.214.611.193.234-.007.455-.111.608-.288.154-.177.227-.409.202-.642-.04-.461-.438-.806-.9-.78-.458.04-.8.441-.765.9l-.045.045zm2.31-.39c.019.252.17.475.398.584.228.11.496.09.705-.053.209-.142.326-.385.307-.637-.007-.189-.092-.366-.234-.491-.142-.125-.328-.186-.516-.169-.36.046-.626.358-.615.72l-.045.045zm1.965.075c.007.165.082.319.207.427.125.108.289.16.453.143.24.015.466-.11.58-.321.114-.211.095-.469-.049-.661-.144-.192-.387-.283-.621-.232-.302.038-.527.296-.525.6l-.045.045zm1.5.375c-.017.212.091.414.278.517.186.103.415.086.585-.041.17-.128.249-.343.202-.55-.024-.292-.277-.512-.57-.495-.233.067-.393.282-.39.525l-.105.045zm1.155.63c-.017.212.091.414.278.517.186.103.415.086.585-.041.17-.128.249-.343.202-.55-.003-.144-.067-.279-.175-.374-.109-.094-.252-.138-.395-.121-.236.063-.398.281-.39.525l-.105.045zm.96.855c.008.142.073.275.18.368.107.093.248.139.39.127.292-.024.512-.277.495-.57-.024-.292-.277-.512-.57-.495-.24.058-.404.279-.39.525l-.105.045z" />
                        <path
                            style={{ opacity: 0.35 }}
                            d="M73.95 33h-6.915c-9.015 0-13.035-4.035-13.035-13.05v-6.915c0-9.015 4.02-13.035 13.035-13.035h6.915c9.015 0 13.05 4.02 13.05 13.035v6.915c0 9.015-4.035 13.05-13.05 13.05zm-6.915-32.4c-8.535 0-12.435 3.9-12.435 12.435v6.915c0 8.55 3.9 12.435 12.435 12.435h6.915c8.595 0 12.435-3.84 12.435-12.435v-6.915c0-8.535-3.885-12.435-12.435-12.435h-6.915zm6.465 24.975h3.585v-3.585h-3.585v3.585zm-3.6-1.8h1.8v-1.8h-1.8v1.8zm-1.83-3.585h1.8v-1.8h-1.8v1.8zm-7.17-1.785h3.6v-3.585h-3.6v3.585zm5.37-7.185h-1.77v1.8h1.77v-1.8zm3.585 0h-1.785v1.785h1.785v-1.785zm5.385 0h3.6v-3.585h-3.6v3.585zm1.8 1.8h-1.8v1.8h1.8v-1.8zm-3.54 5.37h1.77v-1.77h-1.77v1.77z"
                        />
                    </svg>
                );
            case 'transaction':
                return (
                    <svg height="46" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28.76 13.71">
                        <path d="M11.54 10.8l-.09.09.09.08a.3.3 0 0 1 0 .43.34.34 0 0 1-.21.08.35.35 0 0 1-.22-.08l-.11-.09v.09a.35.35 0 0 1-.22.08.34.34 0 0 1-.21-.08.3.3 0 0 1 0-.43l.09-.08-.09-.09a.29.29 0 0 1 0-.42.3.3 0 0 1 .43 0l.08.08.08-.08a.3.3 0 0 1 .43 0 .29.29 0 0 1-.05.42zm1.93-.43a.31.31 0 0 0-.42 0l-.08.09-.09-.09a.31.31 0 0 0-.42 0 .3.3 0 0 0 0 .43l.08.08-.08.09a.3.3 0 1 0 .42.42l.12-.09.08.09a.3.3 0 0 0 .21.09.27.27 0 0 0 .21-.09.29.29 0 0 0 0-.42l-.08-.09.08-.08a.3.3 0 0 0-.03-.43zm1.87.51l.08-.08a.3.3 0 0 0 0-.43.31.31 0 0 0-.42 0l-.09.09-.08-.09a.3.3 0 0 0-.43.43l.09.08-.09.12a.3.3 0 0 0 .22.51.3.3 0 0 0 .21-.09l.08-.09.09.09a.3.3 0 0 0 .42-.42zm2.05.31h-1v.6h1zm9.73 1.39v1.13h-18.4v-5.65h6.64l-5.9-3.06 2.54-5 16.41 8.42-.49.94a1.74 1.74 0 0 1-.8 3.22zm-1.55.73l-9.43-4.85h-7v4.85zm.08-.41l.33-.64h-.06l-.1-.12a1.52 1.52 0 0 1-.26-.35 1 1 0 0 1-.1-.17 1.07 1.07 0 0 1-.09-.27.76.76 0 0 1-.06-.16 1.61 1.61 0 0 1 0-.22v-.07a.41.41 0 0 1 0-.11 1 1 0 0 1 0-.16v-.06a1.18 1.18 0 0 1 .07-.2 1.73 1.73 0 0 1 1.4-1.09h.22a1.76 1.76 0 0 1 .45.07h.09l.31-.59-15.63-8.22-2.22 4.31zm1.07-.31l-.21-.06a1 1 0 0 1-.18-.08l-.44.86h.83zm1.64-1.75a1.32 1.32 0 0 0-.78-1.2 1.4 1.4 0 0 0-.58-.12h-.1a1.31 1.31 0 0 0-.4.1h-.11a1.29 1.29 0 0 0-.3.22 1.15 1.15 0 0 0-.14.17l-.06.08-.07.11a1.4 1.4 0 0 0-.1.35.76.76 0 0 0 0 .16.67.67 0 0 0 0 .2 1.27 1.27 0 0 0 .06.28 1.54 1.54 0 0 0 0 .17 1.45 1.45 0 0 0 .24.35l.08.07a1.33 1.33 0 0 0 2.23-1zm-19.59-.3h-3.25a2.22 2.22 0 0 0-2.18-1.85h-1.43v4.44h1.43a2.22 2.22 0 0 0 2.18-1.87h3.25zm-7.16-1.17v3.11h-1.61v-3.11zm-1.32.29v2.52h1v-2.52z" />
                    </svg>
                );
        }
    }

    render() {
        const { t, addingAdditionalAccount, sendAddressFieldText } = this.props;
        const { view, transaction } = this.state;
        return (
            <div className={classNames(css.modal, view ? css.on : null)}>
                {view && (
                    <div>
                        <span>
                            <Icon icon="info" size={38} />
                        </span>
                        <h2>{t(`ledger:${view}Title`)}</h2>
                        {this.getIcon(view)}
                        {!transaction ? (
                            <p>{t(`ledger:${view}Explanation`)}</p>
                        ) : (
                            <p>
                                <p>
                                    {t('transferConfirmation:youAreAbout', {
                                        contents: `${formatValue(transaction.value)}${formatUnit(transaction.value)}`,
                                    })}
                                </p>
                                <strong>{sendAddressFieldText.substring(0, 30)}</strong>
                                <strong>{sendAddressFieldText.substring(30, 60)}</strong>
                                <strong>{sendAddressFieldText.substring(60, 90)}</strong>
                            </p>
                        )}
                        {view !== 'transaction' &&
                            !addingAdditionalAccount && (
                                <Button variant="secondary" className="outlineSmall" onClick={this.onCancel}>
                                    {t('cancel')}
                                </Button>
                            )}
                    </div>
                )}
            </div>
        );
    }
}

const mapStateToProps = (state) => ({
    addingAdditionalAccount: isSettingUpNewAccount(state),
    sendAddressFieldText: state.ui.sendAddressFieldText,
});

export default connect(mapStateToProps)(withTranslation()(Ledger));
